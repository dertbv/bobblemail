{% extends "base.html" %}

{% block title %}Analytics & Reports - Atlas Email{% endblock %}

{% block page_title %}üìä Analytics & Reports{% endblock %}

{% block extra_css %}
<style>
    /* Analytics-specific styles that override or extend common.css */
    .container {
        max-width: 1400px; /* Wider for analytics */
    }
    
    /* Remove the default body background for analytics page */
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
    }
    
    /* Additional account breakdown card styles */
    .analytics-card.accounts-total-card {
        border-top-color: #17a2b8;
    }
    
    .analytics-card.accounts-spam-card {
        border-top-color: #dc3545;
    }
    
    /* Spam-specific bar styling */
    .bar-fill.spam-bar {
        background: #dc3545 !important;
    }
    
    .bar-value.spam-value {
        color: #dc3545 !important;
    }
    
    /* Auto-refresh notice */
    .refresh-notice {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 15px;
        border-radius: 15px;
        font-size: 0.8em;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
{% if error %}
<div class="analytics-card" style="border-top-color: #dc3545;">
    <div class="card-title color-danger">
        ‚ùå Analytics Error
    </div>
    <p class="color-danger">{{ error }}</p>
    <p>Please try refreshing the page or check the system logs.</p>
</div>
{% else %}
<div class="analytics-grid">
    <div class="analytics-card effectiveness-card">
        <div class="card-title">
            üéØ Processing Effectiveness (30 Days)
        </div>
        <div class="metric-row">
            <div class="metric-label">Total Emails Processed</div>
            <div class="metric-value">{{ "{:,}".format(effectiveness.total_count|default(0)|int) }}</div>
        </div>
        <div class="metric-row">
            <div class="metric-label">Spam Deleted</div>
            <div class="metric-value color-danger">{{ "{:,}".format(effectiveness.deleted_count|default(0)|int) }}</div>
        </div>
        <div class="metric-row">
            <div class="metric-label">Emails Preserved</div>
            <div class="metric-value color-success">{{ "{:,}".format(effectiveness.preserved_count|default(0)|int) }}</div>
        </div>
        <div class="metric-row">
            <div class="metric-label">Detection Rate</div>
            <div class="metric-value" style="color: #fd7e14;">{{ effectiveness_rate|round(1) }}%</div>
        </div>
    </div>
    
    <div class="analytics-card sessions-card">
        <div class="card-title">
            ‚ö° Session Performance (30 Days)
        </div>
        <div class="metric-row">
            <div class="metric-label">Total Sessions</div>
            <div class="metric-value">{{ session_stats.total_sessions|default(0)|int }}</div>
        </div>
        <div class="metric-row">
            <div class="metric-label">Avg Emails/Session</div>
            <div class="metric-value">{{ session_stats.avg_emails_per_session|default(0)|round(0)|int }}</div>
        </div>
        <div class="metric-row">
            <div class="metric-label">Avg Deletion Rate</div>
            <div class="metric-value">{{ session_stats.avg_deletion_rate|default(0)|round(1) }}%</div>
        </div>
    </div>
</div>

<div class="analytics-grid">
    <div class="analytics-card categories-card">
        <div class="card-title">
            üè∑Ô∏è Top Spam Categories (30 Days)
        </div>
        {% if categories %}
            {% set max_percentage = categories | map(attribute='percentage') | max %}
            {% for category in categories %}
                {% set bar_width = (category.percentage / max_percentage * 100) if max_percentage > 0 else 0 %}
                <div class="chart-bar">
                    <div class="bar-label">{{ category.category or 'Unknown' }}</div>
                    <div class="bar-container">
                        <div class="bar-fill" style="width: {{ bar_width|round(1) }}%"></div>
                    </div>
                    <div class="bar-value">{{ "{:,}".format(category.count) }} ({{ category.percentage|round(1) }}%)</div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-center opacity-8">No category data available</p>
        {% endif %}
    </div>
    
    <div class="analytics-card accounts-total-card">
        <div class="card-title">
            üë§ Total Mail by Account (30 Days)
        </div>
        {% if account_breakdown_total %}
            {% set max_account_total_percentage = account_breakdown_total | map(attribute='percentage') | max %}
            {% for account in account_breakdown_total %}
                {% set bar_width = (account.percentage / max_account_total_percentage * 100) if max_account_total_percentage > 0 else 0 %}
                {% set provider_icon = provider_icons.get(account.provider.lower(), 'üìÆ') %}
                <div class="chart-bar">
                    <div class="bar-label">{{ provider_icon }} {{ account.provider.title() }}</div>
                    <div class="bar-container">
                        <div class="bar-fill" style="width: {{ bar_width|round(1) }}%"></div>
                    </div>
                    <div class="bar-value">{{ "{:,}".format(account.email_count) }} ({{ account.percentage|round(1) }}%)</div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-center opacity-8">No account data available</p>
        {% endif %}
    </div>
</div>

<div class="analytics-grid">
    <div class="analytics-card accounts-spam-card">
        <div class="card-title">
            üóëÔ∏è Spam Mail by Account (30 Days)
        </div>
        {% if account_breakdown_spam %}
            {% set max_spam_percentage = account_breakdown_spam | map(attribute='percentage') | max %}
            {% for account in account_breakdown_spam %}
                {% set bar_width = (account.percentage / max_spam_percentage * 100) if max_spam_percentage > 0 else 0 %}
                {% set provider_icon = provider_icons.get(account.provider.lower(), 'üìÆ') %}
                <div class="chart-bar">
                    <div class="bar-label">{{ provider_icon }} {{ account.provider.title() }}</div>
                    <div class="bar-container">
                        <div class="bar-fill spam-bar" style="width: {{ bar_width|round(1) }}%; background-color: #dc3545;"></div>
                    </div>
                    <div class="bar-value spam-value" style="color: #dc3545;">{{ "{:,}".format(account.get('spam_count', account.get('email_count', 0))) }} ({{ account.percentage|round(1) }}%)</div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-center opacity-8">No spam account data available</p>
        {% endif %}
    </div>
</div>

<div class="analytics-grid">
    <div class="analytics-card domains-card">
        <div class="card-title">
            üåê Top Spam Domains (30 Days)
        </div>
        {% if spam_domains %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Domain</th>
                        <th>Blocked Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for domain in spam_domains %}
                        <tr>
                            <td style="font-family: monospace; color: #dc3545;">{{ domain.sender_domain }}</td>
                            <td>{{ "{:,}".format(domain.count) }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="text-center opacity-8">No spam domain data available</p>
        {% endif %}
    </div>
    
    <div class="analytics-card geographic-card">
        <div class="card-title">
            üåç Geographic Intelligence (All Time)
        </div>
        {% if geographic_data %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Country</th>
                        <th>Email Count</th>
                        <th>Percentage</th>
                        <th>Risk Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for geo in geographic_data %}
                        {% set risk_color = '#28a745' if geo.avg_risk_score < 0.3 else '#ffc107' if geo.avg_risk_score < 0.7 else '#dc3545' %}
                        <tr>
                            <td>
                                <a href="#" onclick="showCountryDetails('{{ geo.sender_country_code }}', '{{ geo.sender_country_name }}', {{ geo.count }}, {{ geo.avg_risk_score|round(2) }}); return false;" 
                                   style="text-decoration: none; color: #007bff;">
                                    üè¥ {{ geo.sender_country_name }}
                                </a>
                            </td>
                            <td>{{ "{:,}".format(geo.count) }}</td>
                            <td>{{ geo.percentage|round(1) }}%</td>
                            <td style="color: {{ risk_color }}; font-weight: bold;">
                                {{ geo.avg_risk_score|round(2) if geo.avg_risk_score else 'N/A' }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="text-center opacity-8">No geographic data available</p>
        {% endif %}
    </div>
</div>

<div class="analytics-card activity-card">
    <div class="card-title">
        üìà Daily Activity (Last 14 Days)
    </div>
    {% if daily_activity %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Deleted</th>
                    <th>Preserved</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for day in daily_activity %}
                    <tr>
                        <td>{{ day.date }}</td>
                        <td class="color-danger font-weight-bold">{{ "{:,}".format(day.deleted) }}</td>
                        <td class="color-success font-weight-bold">{{ "{:,}".format(day.preserved) }}</td>
                        <td>{{ "{:,}".format(day.deleted + day.preserved) }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="text-center opacity-8">No daily activity data available</p>
    {% endif %}
</div>

<!-- Auto-refresh notice -->
<div class="refresh-notice">
    Auto-refresh: 30s
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Data refresh functionality
    setInterval(function() {
        window.location.reload();
    }, 30000); // Refresh every 30 seconds
    
    // Add fade-in animation to cards
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.analytics-card');
        cards.forEach((card, index) => {
            card.style.animationDelay = (index * 0.1) + 's';
            card.classList.add('fade-in');
        });
    });
    
    // Country details popup functionality
    function showCountryDetails(countryCode, countryName, emailCount, avgRiskScore) {
        // Show loading popup first
        const loadingPopup = document.createElement('div');
        loadingPopup.innerHTML = `
            <div class="country-popup-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 500px; width: 90%;" onclick="event.stopPropagation()">
                    <h3 style="margin: 0 0 20px 0; color: #333; text-align: center;">üåç ${countryName}</h3>
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 1.2em; color: #666;">Loading classification breakdown...</div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(loadingPopup);
        
        // Fetch classification data
        fetch(`/api/country-classifications/${countryCode}`)
            .then(response => response.json())
            .then(data => {
                // Remove loading popup
                document.querySelector('.country-popup-overlay').remove();
                
                if (data.success && data.classifications.length > 0) {
                    // Build classification table
                    let classificationRows = '';
                    data.classifications.forEach(cls => {
                        classificationRows += `
                            <tr>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">${cls.category}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${cls.count.toLocaleString()}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${cls.percentage.toFixed(1)}%</td>
                            </tr>
                        `;
                    });
                    
                    const popup = document.createElement('div');
                    popup.innerHTML = `
                        <div class="country-popup-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                            <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 500px; width: 90%;" onclick="event.stopPropagation()">
                                <h3 style="margin: 0 0 20px 0; color: #333; text-align: center;">üåç ${countryName}</h3>
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <div style="font-weight: bold; color: #666;">Top Classifications (${emailCount.toLocaleString()} total emails)</div>
                                </div>
                                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Category</th>
                                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;">Count</th>
                                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;">%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${classificationRows}
                                    </tbody>
                                </table>
                                <div style="text-align: center;">
                                    <button onclick="document.querySelector('.country-popup-overlay').remove()" 
                                            style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(popup);
                } else {
                    // Show no data message
                    const popup = document.createElement('div');
                    popup.innerHTML = `
                        <div class="country-popup-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                            <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%;" onclick="event.stopPropagation()">
                                <h3 style="margin: 0 0 20px 0; color: #333; text-align: center;">üåç ${countryName}</h3>
                                <div style="text-align: center; margin: 20px 0;">
                                    <div style="color: #666;">No classification data available for this country</div>
                                </div>
                                <div style="text-align: center;">
                                    <button onclick="document.querySelector('.country-popup-overlay').remove()" 
                                            style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(popup);
                }
            })
            .catch(error => {
                // Remove loading popup and show error
                document.querySelector('.country-popup-overlay').remove();
                console.error('Error fetching classification data:', error);
                
                const popup = document.createElement('div');
                popup.innerHTML = `
                    <div class="country-popup-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%;" onclick="event.stopPropagation()">
                            <h3 style="margin: 0 0 20px 0; color: #333; text-align: center;">üåç ${countryName}</h3>
                            <div style="text-align: center; margin: 20px 0;">
                                <div style="color: #dc3545;">Error loading classification data</div>
                            </div>
                            <div style="text-align: center;">
                                <button onclick="document.querySelector('.country-popup-overlay').remove()" 
                                        style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(popup);
            });
    }
</script>
{% endblock %}