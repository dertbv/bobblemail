{% extends "base.html" %}

{% block title %}Single Account Filter - {{ account.email_address }}{% endblock %}

{% block extra_css %}
<style>
    .account-header {
        display: flex;
        align-items: center;
        background: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 30px;
        border: 1px solid #dee2e6;
    }
    .account-icon {
        font-size: 3em;
        margin-right: 25px;
    }
    .account-details {
        flex: 1;
    }
    .account-email {
        font-size: 1.5em;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }
    .account-provider {
        color: #667eea;
        font-weight: 500;
        margin-bottom: 10px;
    }
    .account-meta {
        color: #6c757d;
        font-size: 0.95em;
    }
    .section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        margin-bottom: 25px;
        overflow: hidden;
    }
    .section-header {
        background: #f8f9fa;
        padding: 20px 25px;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        color: #333;
    }
    .section-content {
        padding: 25px;
    }
    .folder-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
    }
    .folder-item:last-child { border-bottom: none; }
    .folder-name {
        font-weight: 500;
        color: #333;
    }
    .folder-status {
        font-size: 0.9em;
        color: #6c757d;
        padding: 4px 8px;
        background: #e9ecef;
        border-radius: 4px;
    }
    .actions-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    .action-card {
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        padding: 25px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .action-card:hover {
        border-color: #667eea;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transform: translateY(-3px);
    }
    .action-card.preview {
        border-color: #28a745;
    }
    .action-card.process {
        border-color: #dc3545;
    }
    .action-icon {
        font-size: 3em;
        margin-bottom: 15px;
    }
    .action-title {
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 10px;
    }
    .action-description {
        color: #6c757d;
        font-size: 0.95em;
        line-height: 1.4;
    }
    .results-section {
        display: none;
        margin-top: 30px;
    }
    .results-header {
        background: #667eea;
        color: white;
        padding: 20px 25px;
        font-weight: 600;
    }
    .results-content {
        padding: 25px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }
    .stat-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        border: 1px solid #dee2e6;
    }
    .stat-value {
        font-size: 2em;
        font-weight: 600;
        color: #667eea;
        margin-bottom: 5px;
    }
    .stat-label {
        color: #6c757d;
        font-size: 0.9em;
    }
    .no-folders {
        text-align: center;
        color: #6c757d;
        padding: 20px;
    }
    .no-folders code {
        background: #f8f9fa;
        padding: 5px 10px;
        border-radius: 5px;
        font-family: monospace;
    }
    .status-message {
        display: none;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    .loading-spinner {
        font-size: 2em;
        margin-bottom: 15px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    /* Mobile responsive styles */
    @media (max-width: 768px) {
        .actions-grid { grid-template-columns: 1fr; }
        .stats-grid { grid-template-columns: 1fr; }
        .account-header { flex-direction: column; text-align: center; }
        .account-icon { margin-right: 0; margin-bottom: 15px; }
        
        /* Mobile email table improvements */
        .email-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .email-table {
            min-width: 100%;
            font-size: 0.85em;
        }
        
        .email-cell {
            max-width: none !important;
            min-width: 0;
            white-space: normal !important;
            overflow: visible !important;
            text-overflow: initial !important;
            padding: 8px 6px !important;
            line-height: 1.4;
        }
        
        .email-cell-sender {
            max-width: 120px;
            word-break: break-word;
        }
        
        .email-cell-subject {
            max-width: 150px;
            word-break: break-word;
        }
        
        .email-cell-compact {
            padding: 6px 4px !important;
            font-size: 0.8em;
        }
        
        .email-cell-account {
            max-width: 100px;
            word-break: break-word;
        }
    }
    
    @media (max-width: 480px) {
        /* iPhone specific optimizations */
        .container {
            margin: 0 10px;
            border-radius: 10px;
        }
        
        .content {
            padding: 15px;
        }
        
        .account-header {
            padding: 15px;
        }
        
        .email-table {
            font-size: 0.8em;
        }
        
        .email-cell {
            padding: 6px 4px !important;
        }
        
        .email-cell-sender {
            max-width: 100px;
        }
        
        .email-cell-subject {
            max-width: 120px;
        }
        
        .email-cell-account {
            max-width: 80px;
        }                    
        /* Hide less critical columns on very small screens */
        .email-column-confidence,
        .email-column-date {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="nav-links">
    <a href="/accounts" class="back-link">‚Üê Back to Accounts</a>
    <a href="/" class="back-link">üè† Dashboard</a>
</div>

<div class="content">
    <div id="status-message" class="status-message"></div>
    
    <div class="account-header">
        <div class="account-icon">{{ icon }}</div>
        <div class="account-details">
            <div class="account-email">{{ account.email_address }}</div>
            <div class="account-provider">{{ provider }}</div>
            <div class="account-meta">
                {{ target_folders|length }} folders configured ‚Ä¢ Account ID: {{ account_id }}
            </div>
        </div>
    </div>
    
    <div class="section">
        <div class="section-header">
            {% if account_id == "all" %}üåê Target Accounts{% else %}üìÅ Target Folders{% endif %}
        </div>
        <div class="section-content">
            {% if target_folders %}
                {% for folder in target_folders %}
                <div class="folder-item">
                    <span class="folder-name">üìÅ {{ folder }}</span>
                    <span class="folder-status" id="folder-status-{{ folder.replace(' ', '_') }}">Ready</span>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-folders">
                    <p>‚ùå No folders configured for this account.</p>
                    <p>Use the CLI to set up folders: <code>python3 main.py</code></p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="section">
        <div class="section-header">‚ö° Processing Options</div>
        <div class="section-content">
            <div class="actions-grid">
                <div class="action-card preview" onclick="runPreview()">
                    <div class="action-icon">üîç</div>
                    <div class="action-title">Preview Mode</div>
                    <div class="action-description">
                        See what emails would be deleted without actually deleting them. 
                        Safe way to test the filter settings.
                    </div>
                </div>
                
                <div class="action-card process" onclick="runProcess()">
                    <div class="action-icon">üöÄ</div>
                    <div class="action-title">Process Emails</div>
                    <div class="action-description">
                        Actually delete spam emails and preserve important ones. 
                        This will make permanent changes.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="results-section" class="section results-section">
        <div class="results-header">üìä Processing Results</div>
        <div class="results-content">
            <div id="loading" class="loading">
                <div class="loading-spinner">‚è≥</div>
                <div>Processing emails, please wait...</div>
            </div>
            <div id="results-content"></div>
        </div>
    </div>
</div>

<script>
    const accountId = "{{ account_id }}";
    
    async function runPreview() {
        await runAction('preview');
    }
    
    async function runProcess() {
        if (!confirm('‚ö†Ô∏è  This will permanently delete spam emails. Are you sure?')) {
            return;
        }
        await runAction('process');
    }
    
    async function runAction(mode) {
        const statusDiv = document.getElementById('status-message');
        const resultsSection = document.getElementById('results-section');
        const loadingDiv = document.getElementById('loading');
        const resultsContent = document.getElementById('results-content');
        
        // Show status and results section
        statusDiv.className = 'status-message status-info';
        statusDiv.textContent = mode === 'preview' ? 'üîç Running preview...' : 'üöÄ Processing emails...';
        statusDiv.style.display = 'block';
        
        resultsSection.style.display = 'block';
        loadingDiv.style.display = 'block';
        resultsContent.style.display = 'none';
        
        try {
            if (mode === 'preview') {
                // Preview mode: just call preview endpoint
                const response = await fetch(`/api/single-account/${accountId}/preview`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.className = 'status-message status-success';
                    statusDiv.textContent = `‚úÖ Preview completed successfully!`;
                    
                    // Display results
                    const stats = result.data;
                resultsContent.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${stats.total_emails || 0}</div>
                            <div class="stat-label">Total Emails</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color: #dc3545;">${stats.total_deleted || 0}</div>
                            <div class="stat-label">${mode === 'preview' ? 'Would Delete' : 'Deleted'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color: #28a745;">${stats.total_preserved || 0}</div>
                            <div class="stat-label">Preserved</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Object.keys(stats.categories || {}).length}</div>
                            <div class="stat-label">Categories</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px;">
                        <h4>üìä Category Breakdown:</h4>
                        <div id="categories-list">
                            ${Object.entries(stats.categories || {}).map(([category, count]) => 
                                `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                    <span>${category}</span>
                                    <span style="font-weight: 600;">${count} emails</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    ${stats.account_breakdown ? `
                    <div style="margin-top: 25px;">
                        <h4>üåê Account Breakdown:</h4>
                        <div id="account-breakdown-list">
                            ${stats.account_breakdown.map(account => 
                                account.error ? 
                                `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; background-color: #fff5f5;">
                                    <span style="color: #dc3545;">${account.email}</span>
                                    <span style="color: #dc3545; font-weight: 600;">Error: ${account.error}</span>
                                </div>` :
                                `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                    <span>${account.email}</span>
                                    <span style="font-weight: 600;">
                                        <span style="color: #dc3545;">${account.deleted}</span> deleted, 
                                        <span style="color: #28a745;">${account.preserved}</span> preserved
                                    </span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div id="email-details-section" style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0;">üìß Email Details:</h4>
                            ${!(typeof stats.session_id === 'string' && stats.session_id.startsWith('all_')) ? `
                            <div>
                                <button id="show-session-emails" onclick="toggleEmailView('session')" style="background: #667eea; color: white; border: none; padding: 8px 12px; border-radius: 5px; margin-right: 5px; cursor: pointer; font-size: 0.9em;">Current Session</button>
                                <button id="show-all-emails" onclick="toggleEmailView('all')" style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">All Account Emails</button>
                            </div>
                            ` : ''}
                        </div>
                        <div id="email-details-loading" style="text-align: center; padding: 20px; color: #6c757d;">
                            <div style="font-size: 1.5em; margin-bottom: 10px;">‚è≥</div>
                            Loading email details...
                        </div>
                        <div id="email-details-table" style="display: none;"></div>
                    </div>
                    
                    <div style="margin-top: 25px; font-size: 0.9em; color: #6c757d;">
                        Account: ${stats.account_email}<br>
                        Processing Time: ${new Date().toLocaleString()}
                    </div>
                `;
                
                // Load email details table (only if session_id is valid and not "all accounts")
                if (stats.session_id && stats.session_id !== 'undefined' && !(typeof stats.session_id === 'string' && stats.session_id.startsWith('all_'))) {
                    currentSessionId = stats.session_id;
                    loadEmailDetails(stats.session_id);
                } else if (stats.session_id && typeof stats.session_id === 'string' && stats.session_id.startsWith('all_')) {
                    // Handle "all accounts" mode - load emails from multiple sessions
                    if (stats.session_ids && stats.session_ids.length > 0) {
                        loadAllAccountsEmailDetails(stats.session_ids);
                    } else {
                        document.getElementById('email-details-loading').innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #17a2b8;">
                                <div style="font-size: 1.5em; margin-bottom: 10px;">üåê</div>
                                All accounts processing complete. See account breakdown above for detailed results.
                            </div>
                        `;
                    }
                } else {
                    document.getElementById('email-details-loading').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #ffc107;">
                            <div style="font-size: 1.5em; margin-bottom: 10px;">‚ö†Ô∏è</div>
                            Session ID not available. Email details cannot be loaded.
                        </div>
                    `;
                }
                
                loadingDiv.style.display = 'none';
                resultsContent.style.display = 'block';
                } else {
                    statusDiv.className = 'status-message status-error';
                    statusDiv.textContent = `‚ùå Preview failed: ${result.error || 'Unknown error'}`;
                    
                    resultsContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <div style="font-size: 2em; margin-bottom: 15px;">‚ùå</div>
                            <div>Preview failed. Please try again or check the CLI for more details.</div>
                        </div>
                    `;
                    
                    loadingDiv.style.display = 'none';
                    resultsContent.style.display = 'block';
                }
            } else {
                // Process mode: first process, then automatically run preview
                statusDiv.className = 'status-message status-info';
                statusDiv.textContent = `üîÑ Processing emails in background...`;
                
                const processResponse = await fetch(`/api/single-account/${accountId}/process`, {
                    method: 'POST'
                });
                const processResult = await processResponse.json();
                
                if (processResult.success) {
                    // Processing successful - now automatically run preview to show remaining emails
                    statusDiv.textContent = `üîÑ Processing completed! Loading current inbox state...`;
                    
                    const previewResponse = await fetch(`/api/single-account/${accountId}/preview`, {
                        method: 'POST'
                    });
                    const previewResult = await previewResponse.json();
                    
                    if (previewResult.success) {
                        statusDiv.className = 'status-message status-success';
                        statusDiv.textContent = `‚úÖ Processing completed! Showing remaining emails in your inbox:`;
                        
                        // Display preview results (current state of inbox)
                        const stats = previewResult.data;
                        resultsContent.innerHTML = `
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value">${stats.total_emails || 0}</div>
                                    <div class="stat-label">Remaining Emails</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" style="color: #dc3545;">${stats.total_deleted || 0}</div>
                                    <div class="stat-label">Would Delete</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" style="color: #28a745;">${stats.total_preserved || 0}</div>
                                    <div class="stat-label">Preserved</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${Object.keys(stats.categories || {}).length}</div>
                                    <div class="stat-label">Categories</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 25px;">
                                <h4>üìä Category Breakdown:</h4>
                                <div id="categories-list">
                                    ${Object.entries(stats.categories || {}).map(([category, count]) => 
                                        `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                            <span>${category}</span>
                                            <span style="font-weight: 600;">${count} emails</span>
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                            
                            ${stats.account_breakdown ? `
                            <div style="margin-top: 25px;">
                                <h4>üåê Account Breakdown:</h4>
                                <div id="account-breakdown-list">
                                    ${stats.account_breakdown.map(account => 
                                        account.error ? 
                                        `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; background-color: #fff5f5;">
                                            <span style="color: #dc3545;">${account.email}</span>
                                            <span style="color: #dc3545; font-weight: 600;">Error: ${account.error}</span>
                                        </div>` :
                                        `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                            <span>${account.email}</span>
                                            <span style="font-weight: 600;">
                                                <span style="color: #dc3545;">${account.deleted}</span> deleted, 
                                                <span style="color: #28a745;">${account.preserved}</span> preserved
                                            </span>
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            <div id="email-details-section" style="margin-top: 30px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="margin: 0;">üìß Email Details:</h4>
                                    ${!(typeof stats.session_id === 'string' && stats.session_id.startsWith('all_')) ? `
                                    <div>
                                        <button id="show-session-emails" onclick="toggleEmailView('session')" style="background: #667eea; color: white; border: none; padding: 8px 12px; border-radius: 5px; margin-right: 5px; cursor: pointer; font-size: 0.9em;">Current Session</button>
                                        <button id="show-all-emails" onclick="toggleEmailView('all')" style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">All Account Emails</button>
                                    </div>
                                    ` : ''}
                                </div>
                                <div id="email-details-loading" style="text-align: center; padding: 20px; color: #6c757d;">
                                    <div style="font-size: 1.5em; margin-bottom: 10px;">‚è≥</div>
                                    Loading email details...
                                </div>
                                <div id="email-details-table" style="display: none;"></div>
                            </div>
                            
                            <div style="margin-top: 25px; font-size: 0.9em; color: #6c757d;">
                                Account: ${stats.account_email}<br>
                                Processing Time: ${new Date().toLocaleString()}
                            </div>
                        `;
                        
                        // Load email details table (only if session_id is valid and not "all accounts")
                        if (stats.session_id && stats.session_id !== 'undefined' && !(typeof stats.session_id === 'string' && stats.session_id.startsWith('all_'))) {
                            currentSessionId = stats.session_id;
                            loadEmailDetails(stats.session_id);
                        } else if (stats.session_id && typeof stats.session_id === 'string' && stats.session_id.startsWith('all_')) {
                            // Handle "all accounts" mode - load emails from multiple sessions
                            if (stats.session_ids && stats.session_ids.length > 0) {
                                loadAllAccountsEmailDetails(stats.session_ids);
                            } else {
                                document.getElementById('email-details-loading').innerHTML = `
                                    <div style="text-align: center; padding: 20px; color: #17a2b8;">
                                        <div style="font-size: 1.5em; margin-bottom: 10px;">üåê</div>
                                        All accounts processing complete. See account breakdown above for detailed results.
                                    </div>
                                `;
                            }
                        } else {
                            document.getElementById('email-details-loading').innerHTML = `
                                <div style="text-align: center; padding: 20px; color: #ffc107;">
                                    <div style="font-size: 1.5em; margin-bottom: 10px;">‚ö†Ô∏è</div>
                                    Session ID not available. Email details cannot be loaded.
                                </div>
                            `;
                        }
                        
                        loadingDiv.style.display = 'none';
                        resultsContent.style.display = 'block';
                    } else {
                        statusDiv.className = 'status-message status-error';
                        statusDiv.textContent = `‚ùå Failed to load current inbox state: ${previewResult.error || 'Unknown error'}`;
                        
                        resultsContent.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #dc3545;">
                                <div style="font-size: 2em; margin-bottom: 15px;">‚ùå</div>
                                <div>Processing completed but failed to load current state. Please try Preview to see remaining emails.</div>
                            </div>
                        `;
                        
                        loadingDiv.style.display = 'none';
                        resultsContent.style.display = 'block';
                    }
                } else {
                    statusDiv.className = 'status-message status-error';
                    statusDiv.textContent = `‚ùå Processing failed: ${processResult.error || 'Unknown error'}`;
                    
                    resultsContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <div style="font-size: 2em; margin-bottom: 15px;">‚ùå</div>
                            <div>Processing failed. Please try again or check the CLI for more details.</div>
                        </div>
                    `;
                    
                    loadingDiv.style.display = 'none';
                    resultsContent.style.display = 'block';
                }
            }
        } catch (error) {
            statusDiv.className = 'status-message status-error';
            statusDiv.textContent = `‚ùå Error: ${error.message}`;
            
            resultsContent.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #dc3545;">
                    <div style="font-size: 2em; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <div>Network error. Please check your connection and try again.</div>
                </div>
            `;
            
            loadingDiv.style.display = 'none';
            resultsContent.style.display = 'block';
        }
        
        // Auto-hide status message after 10 seconds
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 10000);
    }
    
    async function loadEmailDetails(sessionId) {
        const loadingDiv = document.getElementById('email-details-loading');
        const tableDiv = document.getElementById('email-details-table');
        
        try {
            const response = await fetch(`/api/single-account/${accountId}/emails/${sessionId}`);
            const result = await response.json();
            
            if (result.success && result.emails) {
                const emails = result.emails;
                
                if (emails.length === 0) {
                    tableDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                            <div style="font-size: 1.5em; margin-bottom: 10px;">üì≠</div>
                            No emails found for this session.
                        </div>
                    `;
                } else {
                    displayEmailTable(emails, `all ${emails.length} emails from session ${sessionId}`);
                }
                
                loadingDiv.style.display = 'none';
                tableDiv.style.display = 'block';
            } else {
                tableDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc3545;">
                        <div style="font-size: 1.5em; margin-bottom: 10px;">‚ùå</div>
                        Failed to load email details: ${result.error || 'Unknown error'}
                    </div>
                `;
                loadingDiv.style.display = 'none';
                tableDiv.style.display = 'block';
            }
        } catch (error) {
            tableDiv.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #dc3545;">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">‚ö†Ô∏è</div>
                    Network error loading email details: ${error.message}
                </div>
            `;
            loadingDiv.style.display = 'none';
            tableDiv.style.display = 'block';
        }
    }
    
    function getCategoryColor(category) {
        const colors = {
            'Phishing': '#dc3545',
            'Brand Impersonation': '#fd7e14',
            'Financial & Investment Spam': '#6f42c1',
            'Adult & Dating Spam': '#e83e8c',
            'Marketing Spam': '#20c997',
            'Health & Medical Spam': '#17a2b8',
            'Payment Scam': '#dc3545',
            'Prize & Reward Scam': '#ffc107',
            'Promotional Email': '#28a745',
            'Storage & Backup Scam': '#6c757d',
            'Not Spam': '#28a745'
        };
        return colors[category] || '#6c757d';
    }
    
    let currentSessionId = null;
    
    function toggleEmailView(view) {
        const sessionBtn = document.getElementById('show-session-emails');
        const allBtn = document.getElementById('show-all-emails');
        const loadingDiv = document.getElementById('email-details-loading');
        const tableDiv = document.getElementById('email-details-table');
        
        // Update button styles
        if (view === 'session') {
            sessionBtn.style.background = '#667eea';
            allBtn.style.background = '#6c757d';
            
            if (currentSessionId) {
                loadEmailDetails(currentSessionId);
            }
        } else {
            sessionBtn.style.background = '#6c757d';
            allBtn.style.background = '#667eea';
            
            loadAllAccountEmails();
        }
    }
    
    async function loadAllAccountEmails() {
        const loadingDiv = document.getElementById('email-details-loading');
        const tableDiv = document.getElementById('email-details-table');
        
        loadingDiv.style.display = 'block';
        tableDiv.style.display = 'none';
        loadingDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #6c757d;">
                <div style="font-size: 1.5em; margin-bottom: 10px;">‚è≥</div>
                Loading all account emails...
            </div>
        `;
        
        try {
            const response = await fetch(`/api/single-account/${accountId}/all-emails`);
            const result = await response.json();
            
            if (result.success && result.emails) {
                const emails = result.emails;
                
                if (emails.length === 0) {
                    tableDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                            <div style="font-size: 1.5em; margin-bottom: 10px;">üì≠</div>
                            No emails found for this account.
                        </div>
                    `;
                } else {
                    displayEmailTable(emails, `all ${emails.length} account emails`);
                }
                
                loadingDiv.style.display = 'none';
                tableDiv.style.display = 'block';
            } else {
                tableDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc3545;">
                        <div style="font-size: 1.5em; margin-bottom: 10px;">‚ùå</div>
                        Failed to load account emails: ${result.error || 'Unknown error'}
                    </div>
                `;
                loadingDiv.style.display = 'none';
                tableDiv.style.display = 'block';
            }
        } catch (error) {
            tableDiv.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #dc3545;">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">‚ö†Ô∏è</div>
                    Network error loading account emails: ${error.message}
                </div>
            `;
            loadingDiv.style.display = 'none';
            tableDiv.style.display = 'block';
        }
    }
    
    function displayEmailTable(emails, description) {
        const tableDiv = document.getElementById('email-details-table');
        
        tableDiv.innerHTML = `
            <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
                <div class="email-table-container" style="overflow-x: auto;">
                    <table class="email-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: 600; width: 80px;">üîç Research</th>
                                <th style="padding: 12px; text-align: left; border-right: 1px solid #dee2e6; font-weight: 600;">Sender</th>
                                <th style="padding: 12px; text-align: left; border-right: 1px solid #dee2e6; font-weight: 600;">Subject</th>
                                <th style="padding: 12px; text-align: left; border-right: 1px solid #dee2e6; font-weight: 600;">Category</th>
                                <th class="email-column-confidence" style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: 600;">Confidence</th>
                                <th style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: 600;">Protection</th>
                                <th style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: 600;">Action</th>
                                <th class="email-column-date" style="padding: 12px; text-align: center; font-weight: 600;">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${emails.map(email => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td class="email-cell email-cell-compact" style="padding: 10px; border-right: 1px solid #eee; text-align: center; width: 80px;">
                                        <input type="checkbox" 
                                               onchange="toggleResearchFlag('${email.uid || ''}', '${email.folder_name || ''}', ${email.account_id || 0}, this)"
                                               ${email.is_research_flagged ? 'checked' : ''}
                                               style="cursor: pointer; transform: scale(1.0); accent-color: #28a745; width: 16px; height: 16px; aspect-ratio: 1/1;"
                                               title="Flag for research investigation">
                                    </td>
                                    <td class="email-cell email-cell-sender" style="padding: 10px; border-right: 1px solid #eee; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer;" 
                                        title="${email.sender}"
                                        onmouseover="this.style.textDecoration='underline'"
                                        onmouseout="this.style.textDecoration='none'">
                                        ${(() => {
                                            const s = email.sender || '';
                                            const idx = s.lastIndexOf('<');
                                            return idx > 0 ? s.substring(0, idx).trim() : s;
                                        })()}
                                    </td>
                                    <td class="email-cell email-cell-subject" style="padding: 10px; border-right: 1px solid #eee; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${email.subject}">
                                        ${email.subject}
                                    </td>
                                    <td class="email-cell" style="padding: 10px; border-right: 1px solid #eee;">
                                        <span style="background: ${getCategoryColor(email.category)}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 500;">
                                            ${email.category}
                                        </span>
                                    </td>
                                    <td class="email-cell email-column-confidence" style="padding: 10px; border-right: 1px solid #eee; text-align: center;">
                                        <span style="font-weight: 500; color: ${email.confidence >= 70 ? '#28a745' : email.confidence >= 40 ? '#ffc107' : '#dc3545'};">
                                            ${Math.round(email.confidence)}%
                                        </span>
                                    </td>
                                    <td class="email-cell" style="padding: 10px; border-right: 1px solid #eee; text-align: center;">
                                        <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                            <span style="font-size: 0.8em; color: #6c757d; font-weight: 500;">
                                                ${email.is_protected ? 'Protected' : (email.action === 'DELETED' && !email.is_protected) || email.is_flagged_for_deletion ? 'Delete' : ''}
                                            </span>
                                            ${email.action === 'DELETED' ? `
                                                <button onclick="toggleEmailFlagInTable('${email.uid || ''}', '${email.folder_name || ''}', ${email.account_id || 0}, ${email.is_protected || false}, this, 'protect')" 
                                                        style="border: 1px solid ${email.is_protected ? '#dc3545' : '#28a745'}; background: #f8f9fa; color: ${email.is_protected ? '#dc3545' : '#28a745'}; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; cursor: pointer; transition: all 0.2s;">
                                                    ${email.is_protected ? 'Unmark Protection' : 'Mark for Protection'}
                                                </button>
                                            ` : `
                                                <button onclick="toggleEmailFlagInTable('${email.uid || ''}', '${email.folder_name || ''}', ${email.account_id || 0}, ${email.is_flagged_for_deletion || false}, this, 'delete')" 
                                                        style="border: 1px solid ${email.is_flagged_for_deletion ? '#dc3545' : '#fd7e14'}; background: #f8f9fa; color: ${email.is_flagged_for_deletion ? '#dc3545' : '#fd7e14'}; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; cursor: pointer; transition: all 0.2s;">
                                                    ${email.is_flagged_for_deletion ? 'Unmark for Deletion' : 'Mark for Deletion'}
                                                </button>
                                            `}
                                        </div>
                                    </td>
                                    <td class="email-cell" style="padding: 10px; border-right: 1px solid #eee; text-align: center;">
                                        <span style="background: ${email.action === 'DELETED' ? '#dc3545' : '#28a745'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 500;">
                                            ${email.action}
                                        </span>
                                    </td>
                                    <td class="email-cell email-column-date" style="padding: 10px; text-align: center; font-size: 0.85em; color: #6c757d;">
                                        ${email.timestamp ? (new Date(email.timestamp).toLocaleDateString() === 'Invalid Date' ? email.timestamp : new Date(email.timestamp).toLocaleDateString()) : 'Unknown'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; font-size: 0.9em; color: #6c757d; text-align: center;">
                    Showing ${description}
                    <br>
                    <span style="font-size: 0.85em;">(${emails.filter(e => e.action === 'DELETED' || e.action === 'WOULD DELETE').length} deleted, ${emails.filter(e => e.action === 'PRESERVED' || e.action === 'WOULD PRESERVE').length} preserved)</span>
                </div>
            </div>
        `;
    }
    
    // Toggle email flag function for table view (handles both protect and delete flags)
    async function toggleEmailFlagInTable(emailUid, folderName, accountId, currentlyFlagged, buttonElement, flagType = 'protect') {
        try {
            console.log('toggleEmailFlagInTable called:', { emailUid, folderName, accountId, currentlyFlagged, flagType });
            
            // Validate required parameters
            if (!emailUid || !folderName || !accountId || accountId === 0) {
                throw new Error(`‚ùå Cannot flag this email: Missing email UID or folder information. This email may be from an older session before flagging was enabled.`);
            }
            
            // Disable button during operation
            buttonElement.disabled = true;
            const originalText = buttonElement.textContent;
            buttonElement.textContent = 'Working...';
            
            let endpoint, requestData, successMessage;
            
            if (flagType === 'protect') {
                // Handle protection flags (for DELETED emails)
                const action = currentlyFlagged ? 'unflag' : 'flag';
                endpoint = '/api/emails/' + action;
                requestData = {
                    email_uid: emailUid,
                    folder_name: folderName,
                    account_id: parseInt(accountId)
                };
                if (action === 'flag') {
                    requestData.flag_reason = 'User requested protection from deletion';
                }
                successMessage = currentlyFlagged ? 
                    'Email protection removed' : 
                    'Email protected from deletion';
            } else {
                // Handle delete flags (for PRESERVED emails)
                if (currentlyFlagged) {
                    // Remove delete flag (unflag)
                    endpoint = '/api/emails/unflag';
                    requestData = {
                        email_uid: emailUid,
                        folder_name: folderName,
                        account_id: parseInt(accountId)
                    };
                    successMessage = 'Email unmarked for deletion';
                } else {
                    // Add delete flag
                    endpoint = '/api/emails/flag-for-deletion';
                    requestData = {
                        email_uid: emailUid,
                        folder_name: folderName,
                        account_id: parseInt(accountId),
                        flag_reason: 'User requested deletion override'
                    };
                    successMessage = 'Email marked for deletion';
                }
            }
            
            // Make API call
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Update UI to reflect new state
                const newFlaggedState = !currentlyFlagged;
                
                // Update the status text and button based on flag type
                const statusSpan = buttonElement.parentElement.querySelector('span');
                
                if (flagType === 'protect') {
                    statusSpan.textContent = newFlaggedState ? 'Protected' : '';
                    buttonElement.textContent = newFlaggedState ? 'Unmark Protection' : 'Mark for Protection';
                    buttonElement.style.borderColor = newFlaggedState ? '#dc3545' : '#28a745';
                    buttonElement.style.color = newFlaggedState ? '#dc3545' : '#28a745';
                    
                    // Update onclick handler for new state
                    buttonElement.onclick = function() {
                        toggleEmailFlagInTable(emailUid, folderName, accountId, newFlaggedState, this, 'protect');
                    };
                } else {
                    statusSpan.textContent = newFlaggedState ? 'Delete' : '';
                    buttonElement.textContent = newFlaggedState ? 'Unmark for Deletion' : 'Mark for Deletion';
                    buttonElement.style.borderColor = newFlaggedState ? '#dc3545' : '#fd7e14';
                    buttonElement.style.color = newFlaggedState ? '#dc3545' : '#fd7e14';
                    
                    // Update onclick handler for new state
                    buttonElement.onclick = function() {
                        toggleEmailFlagInTable(emailUid, folderName, accountId, newFlaggedState, this, 'delete');
                    };
                }
                
                // Show success message
                showSuccessMessage(successMessage);
                
            } else {
                throw new Error(result.message || 'Failed to update email flag');
            }
            
        } catch (error) {
            console.error('Flag toggle error:', error);
            alert('‚ùå Error updating protection: ' + error.message);
            
            // Reset button on error
            buttonElement.disabled = false;
            buttonElement.textContent = originalText;
        } finally {
            // Re-enable button
            buttonElement.disabled = false;
        }
    }
    
    // Toggle research flag function for checkbox
    async function toggleResearchFlag(emailUid, folderName, accountId, checkboxElement) {
        try {
            console.log('üîç toggleResearchFlag called:', { emailUid, folderName, accountId, checked: checkboxElement.checked });
            console.log('üîç Checkbox element:', checkboxElement);
            
            // Validate required parameters
            if (!emailUid || !folderName || !accountId || accountId === 0) {
                throw new Error(`‚ùå Cannot flag this email: Missing email UID or folder information.`);
            }
            
            // Disable checkbox during operation
            checkboxElement.disabled = true;
            
            const endpoint = checkboxElement.checked ? '/api/flag-for-research' : '/api/unflag-research';
            const requestData = {
                email_uid: emailUid,
                folder_name: folderName,
                account_id: parseInt(accountId),
                flag_reason: 'User requested classification investigation'
            };
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                const message = checkboxElement.checked ? 
                    'Email flagged for research investigation' : 
                    'Email research flag removed';
                showSuccessMessage(message);
                
                // Force the checkbox to maintain its state and make it visually obvious
                const currentState = checkboxElement.checked;
                checkboxElement.style.backgroundColor = currentState ? '#28a745' : 'transparent';
                checkboxElement.style.border = currentState ? '2px solid #28a745' : '1px solid #ccc';
                
                console.log('‚úÖ Research flag updated successfully, checkbox state:', currentState);
            } else {
                throw new Error(result.message || 'Failed to update research flag');
            }
            
        } catch (error) {
            console.error('Research flag toggle error:', error);
            alert('‚ùå Error updating research flag: ' + error.message);
            
            // Reset checkbox on error
            checkboxElement.checked = !checkboxElement.checked;
        } finally {
            // Re-enable checkbox
            checkboxElement.disabled = false;
        }
    }
    
    function showSuccessMessage(message) {
        // Create and show a temporary success message
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        `;
        messageDiv.textContent = message;
        
        document.body.appendChild(messageDiv);
        
        // Remove after 3 seconds
        setTimeout(() => {
            messageDiv.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => messageDiv.remove(), 300);
        }, 3000);
    }
    
    async function loadAllAccountsEmailDetails(sessionIds) {
        const loadingDiv = document.getElementById('email-details-loading');
        const tableDiv = document.getElementById('email-details-table');
        
        loadingDiv.style.display = 'block';
        tableDiv.style.display = 'none';
        loadingDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #6c757d;">
                <div style="font-size: 1.5em; margin-bottom: 10px;">‚è≥</div>
                Loading emails from all accounts...
            </div>
        `;
        
        try {
            // Convert sessionIds array to JSON string for API call
            const sessionIdsParam = encodeURIComponent(JSON.stringify(sessionIds));
            const response = await fetch(`/api/all-accounts/emails?session_ids=${sessionIdsParam}`);
            const result = await response.json();
            
            if (result.success && result.emails) {
                const emails = result.emails;
                
                if (emails.length === 0) {
                    tableDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                            <div style="font-size: 1.5em; margin-bottom: 10px;">üì≠</div>
                            No emails found across all accounts.
                        </div>
                    `;
                } else {
                    displayAllAccountsEmailTable(emails, `${emails.length} emails from ${result.session_count} accounts`);
                }
                
                loadingDiv.style.display = 'none';
                tableDiv.style.display = 'block';
            } else {
                tableDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc3545;">
                        <div style="font-size: 1.5em; margin-bottom: 10px;">‚ùå</div>
                        Failed to load all accounts emails: ${result.error || 'Unknown error'}
                    </div>
                `;
                loadingDiv.style.display = 'none';
                tableDiv.style.display = 'block';
            }
        } catch (error) {
            tableDiv.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #dc3545;">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">‚ö†Ô∏è</div>
                    Network error loading all accounts emails: ${error.message}
                </div>
            `;
            loadingDiv.style.display = 'none';
            tableDiv.style.display = 'block';
        }
    }
    
    function displayAllAccountsEmailTable(emails, description) {
        const tableDiv = document.getElementById('email-details-table');
        
        tableDiv.innerHTML = `
            <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
                <div class="email-table-container" style="overflow-x: auto;">
                    <table class="email-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: 600; width: 80px;">üîç Research</th>
                                <th style="padding: 12px; text-align: left; border-right: 1px solid #dee2e6; font-weight: 600; width: 140px;">Account</th>
                                <th style="padding: 12px; text-align: left; border-right: 1px solid #dee2e6; font-weight: 600; width: 180px;">Sender</th>
                                <th style="padding: 12px; text-align: left; border-right: 1px solid #dee2e6; font-weight: 600; width: 250px;">Subject</th>
                                <th style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: 600; width: 140px;">Category</th>
                                <th style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: 600; width: 90px;" class="email-column-confidence">Confidence</th>
                                <th style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: 600; width: 110px;">Protection</th>
                                <th style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: 600; width: 100px;">Action</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; width: 100px;" class="email-column-date">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${emails.map(email => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td class="email-cell email-cell-compact" style="padding: 10px; border-right: 1px solid #eee; text-align: center; width: 80px;">
                                        <input type="checkbox" 
                                               onchange="toggleResearchFlag('${email.uid || ''}', '${email.folder_name || ''}', ${email.account_id || 0}, this)"
                                               ${email.is_research_flagged ? 'checked' : ''}
                                               style="cursor: pointer; transform: scale(1.0); accent-color: #28a745; width: 16px; height: 16px; aspect-ratio: 1/1;"
                                               title="Flag for research investigation">
                                    </td>
                                    <td class="email-cell email-cell-account" style="padding: 10px; border-right: 1px solid #eee; width: 140px; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.85em; color: #6c757d;" title="${email.account_email}">
                                        ${email.account_email}
                                    </td>
                                    <td class="email-cell email-cell-sender" style="padding: 10px; border-right: 1px solid #eee; width: 180px; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer;" 
                                        title="${email.sender}"
                                        onmouseover="this.style.textDecoration='underline'"
                                        onmouseout="this.style.textDecoration='none'">
                                        ${(() => {
                                            const s = email.sender || '';
                                            const idx = s.lastIndexOf('<');
                                            return idx > 0 ? s.substring(0, idx).trim() : s;
                                        })()}
                                    </td>
                                    <td class="email-cell email-cell-subject" style="padding: 10px; border-right: 1px solid #eee; width: 250px; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${email.subject}">
                                        ${email.subject}
                                    </td>
                                    <td class="email-cell" style="padding: 10px; border-right: 1px solid #eee; width: 140px; text-align: center;">
                                        <span style="background: ${getCategoryColor(email.category)}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 500;">
                                            ${email.category}
                                        </span>
                                    </td>
                                    <td class="email-cell email-column-confidence" style="padding: 10px; border-right: 1px solid #eee; width: 90px; text-align: center;">
                                        <span style="font-weight: 500; color: ${email.confidence >= 70 ? '#28a745' : email.confidence >= 40 ? '#ffc107' : '#dc3545'};">
                                            ${Math.round(email.confidence)}%
                                        </span>
                                    </td>
                                    <td class="email-cell" style="padding: 10px; border-right: 1px solid #eee; width: 110px; text-align: center;">
                                        <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                            <span style="font-size: 0.8em; color: #6c757d; font-weight: 500;">
                                                ${email.is_protected ? 'Protected' : (email.action === 'DELETED' && !email.is_protected) || email.is_flagged_for_deletion ? 'Delete' : ''}
                                            </span>
                                            ${email.action === 'DELETED' ? `
                                                <button onclick="toggleEmailFlagInTable('${email.uid || ''}', '${email.folder_name || ''}', ${email.account_id || 0}, ${email.is_protected || false}, this, 'protect')" 
                                                        style="border: 1px solid ${email.is_protected ? '#dc3545' : '#28a745'}; background: #f8f9fa; color: ${email.is_protected ? '#dc3545' : '#28a745'}; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; cursor: pointer; transition: all 0.2s;">
                                                    ${email.is_protected ? 'Unmark Protection' : 'Mark for Protection'}
                                                </button>
                                            ` : `
                                                <button onclick="toggleEmailFlagInTable('${email.uid || ''}', '${email.folder_name || ''}', ${email.account_id || 0}, ${email.is_flagged_for_deletion || false}, this, 'delete')" 
                                                        style="border: 1px solid ${email.is_flagged_for_deletion ? '#dc3545' : '#fd7e14'}; background: #f8f9fa; color: ${email.is_flagged_for_deletion ? '#dc3545' : '#fd7e14'}; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; cursor: pointer; transition: all 0.2s;">
                                                    ${email.is_flagged_for_deletion ? 'Unmark for Deletion' : 'Mark for Deletion'}
                                                </button>
                                            `}
                                        </div>
                                    </td>
                                    <td class="email-cell" style="padding: 10px; border-right: 1px solid #eee; width: 100px; text-align: center;">
                                        <span style="background: ${email.action === 'DELETED' ? '#dc3545' : '#28a745'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 500;">
                                            ${email.action}
                                        </span>
                                    </td>
                                    <td class="email-cell email-column-date" style="padding: 10px; width: 100px; text-align: center; font-size: 0.85em; color: #6c757d;">
                                        ${email.timestamp ? (new Date(email.timestamp).toLocaleDateString() === 'Invalid Date' ? email.timestamp : new Date(email.timestamp).toLocaleDateString()) : 'Unknown'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; font-size: 0.9em; color: #6c757d; text-align: center;">
                    Showing ${description}
                    <br>
                    <span style="font-size: 0.85em;">(${emails.filter(e => e.action === 'DELETED' || e.action === 'WOULD DELETE').length} deleted, ${emails.filter(e => e.action === 'PRESERVED' || e.action === 'WOULD PRESERVE').length} preserved)</span>
                </div>
            </div>
        `;
    }
</script>
{% endblock %}