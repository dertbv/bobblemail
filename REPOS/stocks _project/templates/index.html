{% extends "base.html" %}

{% block title %}Stock Analysis - Home{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold text-primary">
                <i class="fas fa-chart-line me-3"></i>
                Multi-Price Stock Analyzer
                <span class="badge bg-success fs-6 ms-2">LIVE DATA</span>
            </h1>
            <p class="lead">
                AI-powered analysis using <strong>real-time market data</strong> to identify top-performing stocks across 
                multiple price ranges with the greatest potential for growth
            </p>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Real Data Features:</strong> Live prices from Yahoo Finance, actual technical indicators, 
                current financial metrics, and real analyst recommendations.
            </div>
        </div>

        <div class="card shadow-lg">
            <div class="card-body p-5">
                <h3 class="card-title text-center mb-4">Start Analysis</h3>
                
                <div id="analysis-status" class="mb-4">
                    <div class="alert alert-info d-none" id="status-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="status-message">Ready to analyze</span>
                    </div>
                    <div class="alert alert-success d-none" id="status-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="success-message">Analysis completed</span>
                    </div>
                    <div class="alert alert-danger d-none" id="status-error">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="error-message">Error occurred</span>
                    </div>
                </div>

                <div class="text-center mb-4">
                    <button id="start-analysis" class="btn btn-primary btn-lg px-5">
                        <i class="fas fa-play me-2"></i>
                        Start Analysis
                    </button>
                    <button id="view-results" class="btn btn-success btn-lg px-5 d-none">
                        <i class="fas fa-eye me-2"></i>
                        View Results
                    </button>
                </div>

                <div id="progress-container" class="d-none">
                    <div class="progress mb-3">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center">
                        <small class="text-muted" id="progress-text">Initializing analysis...</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-bar fa-3x text-primary mb-3"></i>
                        <h5>Technical Analysis</h5>
                        <p class="card-text">
                            Advanced technical indicators including RSI, MACD, moving averages, and volume patterns
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-file-invoice-dollar fa-3x text-success mb-3"></i>
                        <h5>Fundamental Analysis</h5>
                        <p class="card-text">
                            Financial health assessment including revenue growth, profitability, and debt analysis
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-comments fa-3x text-info mb-3"></i>
                        <h5>Sentiment Analysis</h5>
                        <p class="card-text">
                            Market sentiment evaluation from news sources, social media, and analyst coverage
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('start-analysis');
    const viewBtn = document.getElementById('view-results');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    
    // Check for existing results on page load
    checkAnalysisStatus();
    
    startBtn.addEventListener('click', function() {
        startAnalysis();
    });
    
    viewBtn.addEventListener('click', function() {
        window.location.href = '/dashboard';
    });
    
    function startAnalysis() {
        showStatus('info', 'Starting analysis...');
        startBtn.disabled = true;
        progressContainer.classList.remove('d-none');
        
        fetch('/api/start-analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Analysis start response:', data);
            if (data.status === 'success') {
                showStatus('info', 'Analysis in progress...');
                pollAnalysisStatus();
            } else {
                showStatus('error', data.message || 'Unknown error occurred');
                startBtn.disabled = false;
                progressContainer.classList.add('d-none');
            }
        })
        .catch(error => {
            console.error('Error starting analysis:', error);
            showStatus('error', 'Failed to start analysis: ' + error.message);
            startBtn.disabled = false;
            progressContainer.classList.add('d-none');
        });
    }
    
    function pollAnalysisStatus() {
        const phases = [
            'Collecting penny stock universe...',
            'Performing technical analysis...',
            'Analyzing fundamentals...',
            'Processing sentiment data...',
            'Generating final rankings...'
        ];
        
        let currentPhase = 0;
        
        const interval = setInterval(() => {
            fetch('/api/analysis-status')
            .then(response => response.json())
            .then(data => {
                if (data.in_progress) {
                    // Update progress
                    const progress = Math.min((currentPhase + 1) * 20, 90);
                    progressBar.style.width = progress + '%';
                    progressText.textContent = phases[currentPhase % phases.length];
                    currentPhase++;
                } else if (data.has_results) {
                    // Analysis complete
                    clearInterval(interval);
                    progressBar.style.width = '100%';
                    progressText.textContent = 'Analysis complete!';
                    showStatus('success', 'Analysis completed successfully!');
                    startBtn.classList.add('d-none');
                    viewBtn.classList.remove('d-none');
                    progressContainer.classList.add('d-none');
                } else {
                    // Check if there was an error
                    clearInterval(interval);
                    showStatus('error', 'Analysis failed');
                    startBtn.disabled = false;
                    progressContainer.classList.add('d-none');
                }
            })
            .catch(error => {
                clearInterval(interval);
                showStatus('error', 'Failed to check status');
                startBtn.disabled = false;
                progressContainer.classList.add('d-none');
            });
        }, 3000);
    }
    
    function checkAnalysisStatus() {
        fetch('/api/analysis-status')
        .then(response => response.json())
        .then(data => {
            if (data.has_results) {
                showStatus('success', 'Previous analysis results available');
                startBtn.classList.add('d-none');
                viewBtn.classList.remove('d-none');
            } else if (data.in_progress) {
                showStatus('info', 'Analysis in progress...');
                startBtn.disabled = true;
                progressContainer.classList.remove('d-none');
                pollAnalysisStatus();
            }
        })
        .catch(error => {
            console.log('No previous analysis found');
        });
    }
    
    function showStatus(type, message) {
        // Hide all status alerts
        document.getElementById('status-info').classList.add('d-none');
        document.getElementById('status-success').classList.add('d-none');
        document.getElementById('status-error').classList.add('d-none');
        
        // Show appropriate status
        const statusEl = document.getElementById('status-' + type);
        const messageEl = statusEl.querySelector('span');
        messageEl.textContent = message;
        statusEl.classList.remove('d-none');
    }
});
</script>
{% endblock %}