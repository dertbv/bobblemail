{% extends "base.html" %}

{% block title %}Stock Analysis - Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>
                    <i class="fas fa-tachometer-alt me-2"></i>Analysis Dashboard
                    <span class="badge bg-success ms-2">LIVE DATA</span>
                </h2>
                <p class="text-muted mb-0">Real-time market data from Yahoo Finance</p>
            </div>
            <button id="refresh-data" class="btn btn-outline-primary">
                <i class="fas fa-sync-alt me-2"></i>Refresh Analysis
            </button>
        </div>
        
        <div id="loading-spinner" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading analysis results...</p>
        </div>
        
        <div id="no-data" class="text-center py-5 d-none">
            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
            <h4>No Analysis Data Available</h4>
            <p class="text-muted">Please run an analysis first to view results.</p>
            <a href="{{ url_for('index') }}" class="btn btn-primary">
                <i class="fas fa-play me-2"></i>Start Analysis
            </a>
        </div>
        
        <div id="dashboard-content" class="d-none">
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Top Pick</h6>
                                    <h3 id="top-pick-ticker">-</h3>
                                </div>
                                <i class="fas fa-trophy fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Avg Upside</h6>
                                    <h3 id="avg-upside">-</h3>
                                </div>
                                <i class="fas fa-arrow-up fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Analyzed</h6>
                                    <h3 id="total-analyzed">-</h3>
                                </div>
                                <i class="fas fa-search fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Last Updated</h6>
                                    <p id="last-updated" class="mb-0 small">-</p>
                                </div>
                                <i class="fas fa-clock fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Methodology Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Analysis Methodology
                        <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#methodologyCollapse">
                            <i class="fas fa-chevron-down"></i> Learn More
                        </button>
                    </h5>
                </div>
                <div class="collapse" id="methodologyCollapse">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6><i class="fas fa-chart-line text-info me-2"></i>Technical Score</h6>
                                <ul class="small">
                                    <li><strong>Price vs 20-day MA:</strong> 25 points if above moving average</li>
                                    <li><strong>RSI (30-70 range):</strong> 25 points for healthy momentum</li>
                                    <li><strong>Volume surge:</strong> 25 points for volume 10%+ above average</li>
                                    <li><strong>Price momentum:</strong> 25 points for positive 10-day trend</li>
                                </ul>
                                <p class="small text-muted"><strong>Data Source:</strong> Yahoo Finance historical prices and volume</p>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="fas fa-file-invoice-dollar text-success me-2"></i>Fundamental Score</h6>
                                <ul class="small">
                                    <li><strong>Revenue Growth >10%:</strong> 20 points for strong growth</li>
                                    <li><strong>Positive Profit Margins:</strong> 20 points for profitability</li>
                                    <li><strong>Low Debt (D/E <0.5):</strong> 20 points for financial health</li>
                                    <li><strong>Current Ratio >1.5:</strong> 20 points for liquidity</li>
                                    <li><strong>Positive Operating Margins:</strong> 20 points for efficiency</li>
                                </ul>
                                <p class="small text-muted"><strong>Data Source:</strong> Company financial statements via Yahoo Finance</p>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="fas fa-comments text-warning me-2"></i>Sentiment Score</h6>
                                <ul class="small">
                                    <li><strong>Strong Buy/Buy:</strong> 80 points</li>
                                    <li><strong>Hold:</strong> 50 points (neutral baseline)</li>
                                    <li><strong>Sell/Strong Sell:</strong> 20 points</li>
                                </ul>
                                <p class="small text-muted"><strong>Data Source:</strong> Analyst recommendations from financial data providers</p>
                                
                                <div class="alert alert-info mt-3">
                                    <small><strong>Tier-Based Weighting:</strong><br>
                                    • <strong>Tier 1 (Micro):</strong> 60% Tech, 20% Fund, 20% Sent<br>
                                    • <strong>Tier 2 (Penny):</strong> 40% Tech, 40% Fund, 20% Sent<br>
                                    • <strong>Tier 3 (Small-Cap):</strong> 30% Tech, 50% Fund, 20% Sent</small>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6><i class="fas fa-target text-primary me-2"></i>Price Target Calculation</h6>
                                <p class="small">Target prices use tier-adjusted multipliers: <code>Target = Current Price × (1 + Score / Base)</code> where Base varies by tier (T1: 500, T2: 400, T3: 300) to reflect risk/reward profiles.</p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-layer-group text-secondary me-2"></i>Risk Tier Classification</h6>
                                <ul class="small mb-0">
                                    <li><strong>Tier 1 (Micro):</strong> ≤$1.00, ≤$50M cap - Highest risk/reward</li>
                                    <li><strong>Tier 2 (Penny):</strong> ≤$5.00, ≤$300M cap - High risk/reward</li>
                                    <li><strong>Tier 3 (Small-Cap):</strong> ≤$10.00 - Moderate risk/reward</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Price Categories Overview -->
            <div class="row">
                <!-- Under $5 Category -->
                <div class="col-md-4 mb-4">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-fire me-2"></i>Under $5 Stocks
                                <span class="badge bg-light text-danger ms-2">High Risk</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text small">Ultra-Small Cap stocks with highest risk/reward potential</p>
                            <div class="row text-center">
                                <div class="col-6">
                                    <h4 id="under-5-count" class="text-danger">-</h4>
                                    <small class="text-muted">Stocks</small>
                                </div>
                                <div class="col-6">
                                    <h4 id="under-5-avg-upside" class="text-success">-</h4>
                                    <small class="text-muted">Avg Upside</small>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6>Top Pick: <span id="under-5-top-pick" class="text-danger">-</span></h6>
                                <div class="d-grid">
                                    <a href="/category/under-5" class="btn btn-outline-danger">
                                        <i class="fas fa-eye me-2"></i>View All Under $5
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- $5-$10 Category -->
                <div class="col-md-4 mb-4">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>$5 - $10 Stocks
                                <span class="badge bg-light text-warning ms-2">Moderate Risk</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text small">Small Cap stocks with balanced risk/reward profile</p>
                            <div class="row text-center">
                                <div class="col-6">
                                    <h4 id="5-to-10-count" class="text-warning">-</h4>
                                    <small class="text-muted">Stocks</small>
                                </div>
                                <div class="col-6">
                                    <h4 id="5-to-10-avg-upside" class="text-success">-</h4>
                                    <small class="text-muted">Avg Upside</small>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6>Top Pick: <span id="5-to-10-top-pick" class="text-warning">-</span></h6>
                                <div class="d-grid">
                                    <a href="/category/5-to-10" class="btn btn-outline-warning">
                                        <i class="fas fa-eye me-2"></i>View All $5-$10
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- $10-$20 Category -->
                <div class="col-md-4 mb-4">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-shield-alt me-2"></i>$10 - $20 Stocks
                                <span class="badge bg-light text-info ms-2">Lower Risk</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text small">Mid-Small Cap stocks with lower risk, steady growth</p>
                            <div class="row text-center">
                                <div class="col-6">
                                    <h4 id="10-to-20-count" class="text-info">-</h4>
                                    <small class="text-muted">Stocks</small>
                                </div>
                                <div class="col-6">
                                    <h4 id="10-to-20-avg-upside" class="text-success">-</h4>
                                    <small class="text-muted">Avg Upside</small>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6>Top Pick: <span id="10-to-20-top-pick" class="text-info">-</span></h6>
                                <div class="d-grid">
                                    <a href="/category/10-to-20" class="btn btn-outline-info">
                                        <i class="fas fa-eye me-2"></i>View All $10-$20
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Top Picks Table -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-star me-2"></i>Top Stock Picks
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Rank</th>
                                    <th>Stock</th>
                                    <th>Current Price</th>
                                    <th>Target Price</th>
                                    <th>Upside</th>
                                    <th>Score</th>
                                    <th>Technical</th>
                                    <th>Fundamental</th>
                                    <th>Sentiment</th>
                                    <th>Hold Days</th>
                                    <th>Exit Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="picks-table-body">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Charts -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6>Score Distribution</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="score-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6>Upside Potential</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="upside-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let analysisData = null;
    
    loadDashboardData();
    
    document.getElementById('refresh-data').addEventListener('click', function() {
        startNewAnalysis();
    });
    
    function loadDashboardData() {
        showLoading();
        
        fetch('/api/results')
        .then(response => response.json())
        .then(data => {
            console.log('API response:', data);
            if (data.status === 'success') {
                analysisData = data.data;
                console.log('Analysis data:', analysisData);
                populateDashboard(analysisData);
                hideLoading();
                showDashboard();
            } else {
                console.log('No success status');
                hideLoading();
                showNoData();
            }
        })
        .catch(error => {
            console.error('Error loading data:', error);
            hideLoading();
            showNoData();
        });
    }
    
    function populateDashboard(data) {
        console.log('populateDashboard called with:', data);
        const picks = data.top_10_picks || [];
        console.log('Number of picks:', picks.length);
        
        // Update summary cards
        if (picks.length > 0) {
            document.getElementById('top-pick-ticker').textContent = picks[0].ticker;
            
            const avgUpside = picks.reduce((sum, pick) => sum + pick.upside_potential, 0) / picks.length;
            document.getElementById('avg-upside').textContent = avgUpside.toFixed(1) + '%';
        }
        
        document.getElementById('total-analyzed').textContent = picks.length;
        document.getElementById('last-updated').textContent = new Date(data.timestamp).toLocaleString();
        
        // Update category counts
        const under5 = picks.filter(p => p.current_price < 5);
        const between5and10 = picks.filter(p => p.current_price >= 5 && p.current_price < 10);
        const between10and20 = picks.filter(p => p.current_price >= 10 && p.current_price <= 20);
        
        document.getElementById('under-5-count').textContent = under5.length;
        document.getElementById('5-to-10-count').textContent = between5and10.length;
        document.getElementById('10-to-20-count').textContent = between10and20.length;
        
        if (under5.length > 0) {
            const avgUpside = under5.reduce((sum, p) => sum + p.upside_potential, 0) / under5.length;
            document.getElementById('under-5-avg-upside').textContent = avgUpside.toFixed(1) + '%';
            document.getElementById('under-5-top-pick').textContent = under5[0].ticker;
        }
        
        if (between5and10.length > 0) {
            const avgUpside = between5and10.reduce((sum, p) => sum + p.upside_potential, 0) / between5and10.length;
            document.getElementById('5-to-10-avg-upside').textContent = avgUpside.toFixed(1) + '%';
            document.getElementById('5-to-10-top-pick').textContent = between5and10[0].ticker;
        }
        
        if (between10and20.length > 0) {
            const avgUpside = between10and20.reduce((sum, p) => sum + p.upside_potential, 0) / between10and20.length;
            document.getElementById('10-to-20-avg-upside').textContent = avgUpside.toFixed(1) + '%';
            document.getElementById('10-to-20-top-pick').textContent = between10and20[0].ticker;
        }
        
        // Populate table
        const tableBody = document.getElementById('picks-table-body');
        tableBody.innerHTML = '';
        
        picks.forEach((pick, index) => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td><span class="badge bg-primary">${index + 1}</span></td>
                <td>
                    <strong>${pick.ticker}</strong>
                    <br><small class="text-muted">${getExchange(pick.ticker)}</small>
                </td>
                <td>$${pick.current_price.toFixed(2)}</td>
                <td>$${pick.target_price.toFixed(2)}</td>
                <td><span class="badge bg-success">+${pick.upside_potential.toFixed(1)}%</span></td>
                <td>
                    <strong>${pick.composite_score.toFixed(1)}</strong>
                    <div class="progress progress-sm mt-1">
                        <div class="progress-bar bg-primary" style="width: ${pick.composite_score}%"></div>
                    </div>
                </td>
                <td>${pick.technical_score.toFixed(1)}</td>
                <td>${pick.fundamental_score.toFixed(1)}</td>
                <td>${pick.sentiment_score.toFixed(1)}</td>
                <td>
                    <span class="badge bg-info">${pick.optimal_holding_days || 'N/A'}</span>
                </td>
                <td>
                    <small>${pick.exit_date || 'N/A'}</small>
                </td>
                <td>
                    <a href="/stock/${pick.ticker}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-chart-area"></i> View
                    </a>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        // Create charts
        try {
            createCharts(picks);
        } catch (chartError) {
            console.error('Chart creation error:', chartError);
        }
    }
    
    function createCharts(picks) {
        // Score Distribution Chart
        const scoreCtx = document.getElementById('score-chart').getContext('2d');
        new Chart(scoreCtx, {
            type: 'bar',
            data: {
                labels: picks.map(pick => pick.ticker),
                datasets: [{
                    label: 'Technical Score',
                    data: picks.map(pick => pick.technical_score),
                    backgroundColor: 'rgba(54, 162, 235, 0.8)'
                }, {
                    label: 'Fundamental Score',
                    data: picks.map(pick => pick.fundamental_score),
                    backgroundColor: 'rgba(255, 99, 132, 0.8)'
                }, {
                    label: 'Sentiment Score',
                    data: picks.map(pick => pick.sentiment_score),
                    backgroundColor: 'rgba(75, 192, 192, 0.8)'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
        
        // Upside Potential Chart
        const upsideCtx = document.getElementById('upside-chart').getContext('2d');
        new Chart(upsideCtx, {
            type: 'doughnut',
            data: {
                labels: picks.slice(0, 5).map(pick => pick.ticker),
                datasets: [{
                    data: picks.slice(0, 5).map(pick => pick.upside_potential),
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    function showLoading() {
        document.getElementById('loading-spinner').classList.remove('d-none');
        document.getElementById('dashboard-content').classList.add('d-none');
        document.getElementById('no-data').classList.add('d-none');
    }
    
    function hideLoading() {
        document.getElementById('loading-spinner').classList.add('d-none');
    }
    
    function showDashboard() {
        document.getElementById('dashboard-content').classList.remove('d-none');
    }
    
    function showNoData() {
        document.getElementById('no-data').classList.remove('d-none');
    }
    
    function getExchange(ticker) {
        // Simple heuristic for exchange determination
        const nasdaqTickers = ['SNDL', 'TLRY', 'NIO', 'WKHS', 'CLOV', 'AMC', 'ATOS', 'CTXR', 'SENS', 'SAVA', 'BNGO', 'OCGN'];
        return nasdaqTickers.includes(ticker) ? 'NASDAQ' : 'NYSE';
    }
    
    function generatePredictionRationale(pick) {
        let rationale = `<strong>${pick.ticker}</strong> is recommended for the following reasons:\\n\\n`;
        
        // Technical analysis rationale
        if (pick.technical_score >= 75) {
            rationale += `<span class="text-info">📈 <strong>Strong Technical Signals:</strong></span> Excellent technical indicators with score of ${pick.technical_score}/100. The stock shows positive momentum, healthy volume patterns, and favorable price trends.\\n\\n`;
        } else if (pick.technical_score >= 50) {
            rationale += `<span class="text-info">📊 <strong>Positive Technical Outlook:</strong></span> Good technical setup with score of ${pick.technical_score}/100. Some technical indicators are favorable for potential upward movement.\\n\\n`;
        } else {
            rationale += `<span class="text-muted">📉 <strong>Mixed Technical Signals:</strong></span> Technical score of ${pick.technical_score}/100 indicates neutral technical conditions.\\n\\n`;
        }
        
        // Fundamental analysis rationale
        if (pick.fundamental_score >= 60) {
            rationale += `<span class="text-success">💰 <strong>Strong Fundamentals:</strong></span> Solid fundamental score of ${pick.fundamental_score}/100. The company shows good financial health, growth potential, or attractive valuation metrics.\\n\\n`;
        } else if (pick.fundamental_score >= 40) {
            rationale += `<span class="text-success">💼 <strong>Adequate Fundamentals:</strong></span> Fundamental score of ${pick.fundamental_score}/100 indicates reasonable financial position with some positive factors.\\n\\n`;
        } else {
            rationale += `<span class="text-warning">⚠️ <strong>Fundamental Challenges:</strong></span> Lower fundamental score of ${pick.fundamental_score}/100. Consider this a speculative play with higher risk.\\n\\n`;
        }
        
        // Sentiment rationale
        if (pick.sentiment_score >= 70) {
            rationale += `<span class="text-warning">🎯 <strong>Positive Market Sentiment:</strong></span> High sentiment score of ${pick.sentiment_score}/100 with analyst recommendations leaning positive.\\n\\n`;
        } else {
            rationale += `<span class="text-muted">📊 <strong>Neutral Sentiment:</strong></span> Sentiment score of ${pick.sentiment_score}/100 indicates neutral market opinion.\\n\\n`;
        }
        
        // Overall prediction
        if (pick.composite_score >= 60) {
            rationale += `<span class="text-primary"><strong>🚀 Investment Thesis:</strong></span> With a composite score of ${pick.composite_score}/100, this stock shows strong potential for the ${pick.upside_potential.toFixed(1)}% projected upside. The combination of technical momentum and fundamental strength makes it an attractive penny stock opportunity.`;
        } else {
            rationale += `<span class="text-secondary"><strong>💡 Investment Thesis:</strong></span> Composite score of ${pick.composite_score}/100 suggests moderate potential with ${pick.upside_potential.toFixed(1)}% projected upside. This represents a speculative opportunity that could benefit from positive catalysts.`;
        }
        
        return rationale;
    }
    
    function showRationale(ticker, rationale) {
        document.getElementById('rationaleModalLabel').textContent = `Why ${ticker}? - Investment Rationale`;
        document.getElementById('rationaleContent').innerHTML = rationale.replace(/\\n/g, '<br>');
    }
    
    function showHoldingPeriod(ticker, optimalHold, exitWindow, confidence) {
        document.getElementById('holdingModalLabel').textContent = `${ticker} - Optimal Holding Period`;
        document.getElementById('holdingOptimalPeriod').textContent = optimalHold;
        document.getElementById('holdingExitWindow').textContent = exitWindow;
        document.getElementById('holdingConfidence').textContent = confidence + '%';
        document.getElementById('holdingConfidenceBar').style.width = confidence + '%';
        
        // Add confidence color
        const confidenceBar = document.getElementById('holdingConfidenceBar');
        if (confidence >= 80) {
            confidenceBar.className = 'progress-bar bg-success';
        } else if (confidence >= 60) {
            confidenceBar.className = 'progress-bar bg-warning';
        } else {
            confidenceBar.className = 'progress-bar bg-danger';
        }
    }
    
    function startNewAnalysis() {
        const refreshBtn = document.getElementById('refresh-data');
        const originalText = refreshBtn.innerHTML;
        
        // Update button to show loading state
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting Analysis...';
        
        // Start the analysis
        fetch('/api/start-analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                refreshBtn.innerHTML = '<i class="fas fa-clock me-2"></i>Analysis Running...';
                // Poll for completion
                pollAnalysisStatus();
            } else {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalText;
                alert('Error starting analysis: ' + data.message);
            }
        })
        .catch(error => {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = originalText;
            alert('Error starting analysis');
        });
    }
    
    function pollAnalysisStatus() {
        const refreshBtn = document.getElementById('refresh-data');
        
        fetch('/api/analysis-status')
        .then(response => response.json())
        .then(data => {
            if (data.in_progress) {
                // Still running, check again in 3 seconds
                setTimeout(pollAnalysisStatus, 3000);
            } else {
                // Analysis complete, reload data and reset button
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Refresh Analysis';
                loadDashboardData();
            }
        })
        .catch(error => {
            // Error checking status, reset button
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Refresh Analysis';
        });
    }
});
</script>

<!-- Rationale Modal -->
<div class="modal fade" id="rationaleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rationaleModalLabel">Investment Rationale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="rationaleContent"></div>
                <div class="alert alert-warning mt-3">
                    <small><strong>Disclaimer:</strong> This analysis is for informational purposes only. Past performance does not guarantee future results. Always conduct your own research and consult financial advisors before making investment decisions.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Holding Period Modal -->
<div class="modal fade" id="holdingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="holdingModalLabel">Optimal Holding Period</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title text-muted">Recommended Hold Period</h6>
                                <h2 class="text-primary" id="holdingOptimalPeriod">-</h2>
                                <small class="text-muted">Based on momentum analysis</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title text-muted">Optimal Exit Window</h6>
                                <h3 class="text-success" id="holdingExitWindow">-</h3>
                                <small class="text-muted">Best time to consider selling</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6><i class="fas fa-chart-line me-2"></i>Analysis Confidence</h6>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Confidence Level</span>
                        <span id="holdingConfidence" class="fw-bold">-</span>
                    </div>
                    <div class="progress">
                        <div id="holdingConfidenceBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-4">
                    <h6><i class="fas fa-info-circle me-2"></i>How We Calculate Holding Periods</h6>
                    <ul class="mb-0 small">
                        <li><strong>Base Period:</strong> Tier-specific starting point (Tier 1: 30 days, Tier 2: 60 days, Tier 3: 120 days)</li>
                        <li><strong>Momentum Analysis:</strong> Technical and fundamental scores combined to assess sustainability</li>
                        <li><strong>RSI Adjustments:</strong> Overbought conditions reduce holding time, oversold extends it</li>
                        <li><strong>Volume Patterns:</strong> High volume supports longer holds, low volume suggests shorter periods</li>
                        <li><strong>Risk Factors:</strong> Higher tier stocks get longer default holding periods due to stability</li>
                    </ul>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <small><strong>Important:</strong> These are algorithmic recommendations based on historical patterns and current technical indicators. Market conditions can change rapidly. Always monitor your positions and consider your risk tolerance when making exit decisions.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}