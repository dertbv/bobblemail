#!/bin/bash

# ATLAS Enhanced Orchestration Trigger with Todo Integration
# Usage: ./atlas-orchestrate "task description" [--todos]

echo "🏛️  ATLAS Enhanced Orchestration Mode"
echo "════════════════════════════════════════"
echo ""

# Parse arguments
TASK_DESCRIPTION=""
CREATE_TODOS=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --todos)
            CREATE_TODOS=true
            shift
            ;;
        *)
            if [ -z "$TASK_DESCRIPTION" ]; then
                TASK_DESCRIPTION="$1"
            fi
            shift
            ;;
    esac
done

if [ -z "$TASK_DESCRIPTION" ]; then
    echo "Usage: ./atlas-orchestrate \"Complex task description\" [--todos]"
    echo ""
    echo "Options:"
    echo "  --todos    Create trackable todos in Claude Code"
    echo ""
    echo "Examples:"
    echo "  ./atlas-orchestrate \"Implement OAuth authentication system\""
    echo "  ./atlas-orchestrate \"Debug performance issues\" --todos"
    echo "  ./atlas-orchestrate \"Refactor database schema for scalability\" --todos"
    exit 1
fi

TIMESTAMP=$(date +"%Y_%m_%d_%H%M")

echo "📋 Task: $TASK_DESCRIPTION"
echo "⏰ Started: $(date)"
echo "📂 Enhanced Orchestration Protocol: @SELF/ENHANCED_ORCHESTRATION.md"
if [ "$CREATE_TODOS" = true ]; then
    echo "✅ Todo Integration: Enabled"
fi
echo ""

# Update FRESH_COMPACT_MEMORY with current task
echo "## ATLAS Enhanced Orchestration Session - $TIMESTAMP" >> FRESH_COMPACT_MEMORY.md
echo "" >> FRESH_COMPACT_MEMORY.md
echo "**Task**: $TASK_DESCRIPTION" >> FRESH_COMPACT_MEMORY.md
echo "**Started**: $(date)" >> FRESH_COMPACT_MEMORY.md
echo "**Mode**: Enhanced Orchestration (Complex Multi-Task)" >> FRESH_COMPACT_MEMORY.md
if [ "$CREATE_TODOS" = true ]; then
    echo "**Todo Integration**: Enabled" >> FRESH_COMPACT_MEMORY.md
fi
echo "" >> FRESH_COMPACT_MEMORY.md

# Create working log entry
CURRENT_DATE=$(date +"%Y_%m_%d")
CURRENT_MONTH_DIR="WORKING_LOG/$(date +"%Y/%m-%b")"
WORKING_LOG_FILE="$CURRENT_MONTH_DIR/wl_$CURRENT_DATE.md"

# Ensure directory exists
mkdir -p "$CURRENT_MONTH_DIR"

# Add entry to working log
echo "" >> "$WORKING_LOG_FILE"
echo "## ENHANCED ORCHESTRATION SESSION - $TIMESTAMP" >> "$WORKING_LOG_FILE"
echo "" >> "$WORKING_LOG_FILE"
echo "**Task**: $TASK_DESCRIPTION" >> "$WORKING_LOG_FILE"
echo "**Mode**: Enhanced Orchestration Protocol" >> "$WORKING_LOG_FILE"
echo "**Status**: Planning Phase" >> "$WORKING_LOG_FILE"
if [ "$CREATE_TODOS" = true ]; then
    echo "**Todo Integration**: Enabled" >> "$WORKING_LOG_FILE"
fi
echo "" >> "$WORKING_LOG_FILE"

# Create todo file if requested
if [ "$CREATE_TODOS" = true ]; then
    TODO_FILE="atlas_orchestration_todos_$TIMESTAMP.md"
    
    cat > "$TODO_FILE" << EOF
# ATLAS Enhanced Orchestration Todos
**Task**: $TASK_DESCRIPTION  
**Created**: $(date)  
**Session**: $TIMESTAMP

## Phase 1: ATLAS Strategic Planning
- [ ] **Experience-based analysis**: Apply FAANG + startup experience to understand scope
- [ ] **Professional task decomposition**: Break into logical subtasks using engineering best practices  
- [ ] **Quality standards setting**: Apply DEVELOPMENT_BELIEFS.md principles and set acceptance criteria

## Phase 2: ATLAS Systematic Execution  
- [ ] **Context loading**: Review relevant MEMORY/ and WORKING_LOG/ sections
- [ ] **Subtask implementation**: Work through each identified subtask systematically
- [ ] **Progress documentation**: Update FRESH_COMPACT_MEMORY.md with insights and progress
- [ ] **Inter-subtask coordination**: Maintain context between related work pieces

## Phase 3: ATLAS Quality Orchestration
- [ ] **Professional quality evaluation**: Apply accumulated standards to assess work quality
- [ ] **Business value verification**: Ensure solution meets original requirements
- [ ] **Code review preparation**: Stage work and request Boss review with clear context
- [ ] **Iteration if needed**: Refine work if quality doesn't meet professional standards

## Phase 4: ATLAS Learning Integration  
- [ ] **Pattern extraction**: Identify new techniques and approaches for future similar work
- [ ] **Memory system updates**: Update relevant MEMORY/ files with insights and learnings
- [ ] **Working log documentation**: Document high-entropy information and surprising discoveries
- [ ] **Professional growth**: Reflect on how accumulated experience applied to this challenge

---

## Custom Subtasks
*Add your specific subtasks here as you identify them during Phase 1 planning:*

- [ ] 
- [ ] 
- [ ] 

## Notes & Insights
*Capture key insights, decisions, and learnings throughout the process:*

EOF

    echo "📝 Created todo file: $TODO_FILE"
    echo "💡 Tip: Use this file to track progress and add specific subtasks during planning"
    echo ""
fi

# Add standard working log checklist
echo "### Phase 1: ATLAS Strategic Planning" >> "$WORKING_LOG_FILE"
echo "- [ ] Experience-based analysis" >> "$WORKING_LOG_FILE"
echo "- [ ] Professional task decomposition" >> "$WORKING_LOG_FILE"
echo "- [ ] Quality standards setting" >> "$WORKING_LOG_FILE"
echo "" >> "$WORKING_LOG_FILE"
echo "### Phase 2: ATLAS Systematic Execution" >> "$WORKING_LOG_FILE"
echo "- [ ] Subtask implementation loop" >> "$WORKING_LOG_FILE"
echo "- [ ] Inter-subtask context management" >> "$WORKING_LOG_FILE"
echo "" >> "$WORKING_LOG_FILE"
echo "### Phase 3: ATLAS Quality Orchestration" >> "$WORKING_LOG_FILE"
echo "- [ ] Professional quality evaluation" >> "$WORKING_LOG_FILE"
echo "- [ ] Iteration decision framework" >> "$WORKING_LOG_FILE"
echo "- [ ] Git integration with enhanced workflow" >> "$WORKING_LOG_FILE"
echo "" >> "$WORKING_LOG_FILE"
echo "### Phase 4: ATLAS Learning Integration" >> "$WORKING_LOG_FILE"
echo "- [ ] Knowledge extraction" >> "$WORKING_LOG_FILE"
echo "- [ ] Memory system updates" >> "$WORKING_LOG_FILE"
echo "- [ ] Professional growth integration" >> "$WORKING_LOG_FILE"
echo "" >> "$WORKING_LOG_FILE"

echo "✅ Session initialized"
echo "📝 Updated: FRESH_COMPACT_MEMORY.md"
echo "📊 Created: $WORKING_LOG_FILE"

if [ "$CREATE_TODOS" = true ]; then
    echo ""
    echo "🎯 Todo Management Integration:"
    echo "   1. Open $TODO_FILE in Claude Code"
    echo "   2. Add specific subtasks during Phase 1 planning"
    echo "   3. Check off items as you complete them"
    echo "   4. Use Claude Code's todo features to track progress"
fi

echo ""
echo "Ready for Enhanced Orchestration Protocol..."
echo "Refer to @SELF/ENHANCED_ORCHESTRATION.md for detailed workflow"
